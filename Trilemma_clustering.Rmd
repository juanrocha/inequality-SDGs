---
title: "Trilemma"
author: "Juan Rocha"
date: "Updated `r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    toc_float: yes
    highlight: tango
    code_folding: hide
    df_print: paged
    theme: 
      bootswatch: cosmo
      code_font:
        google: Fira Code
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  cache = TRUE, warning = FALSE, message = FALSE, echo = TRUE,
  fig.width = 8, fig.height = 5
)


library(tidyverse)
library(naniar)
library(plotly)
library(patchwork)

# time series
library(tsibble)
library(fable)
library(imputeTS)
library(slider)

# # clustering
# library(vegan)
# library(NbClust)
# library(clValid)
# library(mclust)

#theme_set(theme_light(base_size = 12))
```


## Data


```{r}
ecofp <- list()
fls <- list.files("data/ecofootprint/")
ecofp <- map(fls, function(x) {
    jsonlite::read_json(
        path = paste0("data/ecofootprint/", x),
        simplifyVector = TRUE)
    }) %>% 
    bind_rows()

ecofp
```

```{r}
inq <- readxl::read_xlsx(
    path = "~/Documents/Projects/DATA/WIID_World_Income_Inequality_DB/WIID_06MAY2020.xlsx")
inq
```


```{r}
dat1 <- read_csv(
    "~/Documents/Projects/DATA/WorldBank/SDG_csv/SDGData.csv") %>% 
    janitor::clean_names()

missingness <- dat1 %>% 
    select(-last_col()) %>% 
    filter(str_detect(indicator_name, "GNI")) %>% 
    pivot_longer(cols = x1990:x2019, names_to = "year", values_to = "value") %>% 
    mutate(year = str_remove(year, "x")) %>% 
    mutate(year = as.numeric(year)) %>% 
    mutate(ismissing = is.na(value)) %>% 
    group_by(country_code, indicator_name, country_name) %>% 
    summarize(missingness = sum(ismissing)/n())

missingness%>% 
    ggplot(aes(country_code, indicator_name)) +
    geom_tile(aes(fill = missingness)) + 
    scale_fill_viridis_c(option = "C") +
    theme(axis.text.x = element_text(angle =90), legend.position = "top")
```

## Analysis

The bottle neck is certaintly our proxies of inequality, no matter what we use. Based on the missing data explorations, inequality data improves from 1995 onward.

```{r}

dat <- ecofp %>%
  filter(record == "EFConsPerCap") %>%
  select(countryName, isoa2, year, value) %>% 
  rename(EFconsPerCap = value, country = countryName) %>% 
  filter(year >= 1995)

dat <- dat %>% 
  left_join(
    .,
    inq %>% 
      filter(!is.na(gini_reported), year >= 1995) %>% 
      select(country, isoa2 = c2, country_code = c3, year, gini_reported) %>% 
      group_by(country, year, isoa2, country_code) %>% 
      summarize(gini_mean = mean(gini_reported, na.rm = TRUE)) 
      
  )

dat <- dat %>% 
  left_join(
    ., 
    dat1 %>% 
      select(-last_col()) %>% 
      filter(indicator_name == "GNI per capita (US$)") %>% 
      pivot_longer(cols = x1990:x2019, names_to = "year", values_to = "value") %>%
      mutate(year = str_remove(year, "x")) %>% 
      mutate(year = as.numeric(year)) %>% 
      mutate(ismissing = is.na(value)) %>% 
      filter(year >= 1995) %>% 
      rename(country = country_name, gni = value)
  )

dat

```

Compute missing values for inequality:
```{r}
missingness <- dat %>% 
    mutate(ismissing = is.na(gini_mean)) %>% 
    group_by(country) %>% 
    summarize(missingness = sum(ismissing)/n()) %>% 
    arrange(missingness)


key_countries <- missingness %>% 
    filter(missingness <= 0.3) %>% 
    pull(country)

droped_countries <- missingness %>% 
    filter(missingness > 0.3) %>% 
    pull(country)
```

```{r}
#library(tsibbledata)
df_dat <- dat %>% 
    select(-starts_with("indicator")) %>% 
    filter(country %in% key_countries) %>% 
    as_tsibble(key = country, index = year) 
    
df_dat <- df_dat %>% 
    fill_gaps(.full = TRUE)

```

```{r}

df_dat <- df_dat %>% 
    group_by(country) %>% 
    mutate(
        gini = na_interpolation(gini_mean),
        gni2 = na_interpolation(gni),
        EFconsPerCap = na_interpolation(EFconsPerCap)
    ) 
```



```{r message=FALSE, warning=FALSE}
p <- df_dat %>% 
    select(year, `Ecological footprint` = EFconsPerCap, GNI = gni2, Gini = gini) %>% 
    GGally::ggpairs(
        columns = 3:5 ,
    lower = list(continuous = GGally::wrap("points", alpha = 0.5, size = 0.5)),
    diag = list(continuous = GGally::wrap("densityDiag", alpha = 0.2))
    # upper = list(continuous = GGally::wrap("cor", size = 2))
    ) + theme_light(base_size = 6)

# ggsave(
#     plot = p,
#     file = "correlogram.png", path = "figures/", device = "png",
#     width = 4, height = 4, dpi = 300, bg = "white"
# )
p + theme_light(base_size = 20)
```


```{r}
df_dat <- df_dat %>% 
    select(EFconsPerCap, gini, gni2) %>% 
    filter(!is.na(gni2))   # lost 2 more countries due to NAs
    
```

```{r}
df_dat %>% 
    pivot_longer(cols = c("EFconsPerCap", "gini", "gni2"),
                 names_to = "variable", values_to = "value") %>% 
    ggplot(aes(year, value)) +
    geom_line(aes(group = country)) +
    facet_wrap(~variable, ncol = 1, scales = "free") +
    theme_light(base_size = 15)
```

```{r}
p1 <- df_dat %>% 
    ggplot(aes(EFconsPerCap, gini, group = country)) +
    geom_point(size = 0.5) +
    geom_path(size = 0.2, aes(color = year)) +
    annotate(geom = "rect", xmin = 0, xmax = 1.68, ymin = 20, ymax = 30,
             fill = "skyblue", alpha = 0.25) +
    annotate(geom ="rect",xmin = 0, xmax = 1.68, ymin = 30, ymax = 62,
             fill = "orange", alpha = 0.1) +
    annotate(geom ="rect", xmin = 1.68, xmax = 18, ymin = 20, ymax = 30,
             fill = "orange", alpha = 0.1) +
    annotate(geom="rect", xmin = 1.68, xmax = 18, ymin = 30, ymax = 62,
             fill = "red", alpha = 0.1) +
    geom_hline(yintercept = 30, linetype = 2, color = "gray50") +
    geom_vline(xintercept = 1.68, linetype = 2, color = "gray50") +
    scico::scale_color_scico("Year", palette = "bilbao") +
    labs(y = "Gini", x = "Ecological footprint") + theme_light() +
    theme(legend.position = "top", panel.grid = element_blank(),
          legend.key.width = unit(10, "mm"), legend.key.height = unit(3,"mm"))

p2<- df_dat %>% 
  ggplot(aes(gni2, gini, group = country)) +
  geom_point(size = 0.5, show.legend = FALSE) +
  geom_path(size = 0.2, aes(color = year)) +
    annotate(geom = "rect", xmin = 10, xmax = 1.68, ymin = 20, ymax = 30,
             fill = "skyblue", alpha = 0.25) +
    annotate(geom ="rect",xmin = 0, xmax = 1.68, ymin = 30, ymax = 62,
             fill = "orange", alpha = 0.1) +
    annotate(geom ="rect", xmin = 1.68, xmax = 18, ymin = 20, ymax = 30,
             fill = "orange", alpha = 0.1) +
    annotate(geom="rect", xmin = 1.68, xmax = 18, ymin = 30, ymax = 62,
             fill = "red", alpha = 0.1) +
    geom_hline(yintercept = 30, linetype = 2, color = "gray50") +
    geom_vline(xintercept = 12746, linetype = 2, color = "gray50") +
    scico::scale_color_scico("Year", palette = "bilbao") +
      scale_x_log10() +
    labs(y = "Gini", x = "Ecological footprint") + theme_light() +
    theme(legend.position = "top", panel.grid = element_blank(),
          legend.key.width = unit(10, "mm"), legend.key.height = unit(3,"mm"))


p3<- df_dat %>% 
  ggplot(aes(gni2, EFconsPerCap, group = country)) +
  geom_point(size = 0.5, show.legend = FALSE) +
  geom_path(size = 0.2, aes(color = year)) +
  scale_x_log10()

p1 + p2 + p3 + plot_layout(guides = "collect") & theme_light(base_size = 18)
```

```{r}
df_dat %>% 
    as_tibble() %>% 
    group_by(country) %>% 
    summarize(
        mean_ef = mean(EFconsPerCap),
        mean_gni = mean(gni2),
        mean_gini = mean(gini),
        var_ef = var(EFconsPerCap),
        var_gni = var(gni2),
        var_gini = var(gini)
    ) %>% 
    arrange(desc(mean_ef))
```
### Experimenting with phase plane

```{r}
df_dat <- df_dat |> 
    # change scale of GNI to log so the magnitud is not so dominated by $
    mutate(gni_log = log(gni2)) |> 
    mutate(
        d_EF = slide_dbl(EFconsPerCap, diff, .before = 1, .after = 0, .complete = TRUE),
        d_gini = slide_dbl(gini, diff, .before = 1, .after = 0, .complete = TRUE),
        d_gni = slide_dbl(gni_log, diff, .before = 1, .after = 0, .complete = TRUE)
    ) |> 
    mutate(
        magni = sqrt(d_EF^2 + d_gini^2 + d_gni^2), 
        theta = atan(d_gini/d_EF),
        gamma = atan(d_gini/d_gni)
    ) 
```

```{r}
df_dat |> 
    as_tibble() |> 
    ungroup() |> 
    group_by(country) |> 
    summarize(mgt = sum(magni, na.rm = TRUE), 
              theta = sum(theta, na.rm = TRUE),
              gamma = sum(gamma, na.rm = TRUE)) |> 
    arrange(desc(mgt))
```
```{r fig.width=6, fig.height=3}
p <- df_dat |> 
    as_tibble() |> 
    select(country, year, d_EF, d_gini, d_gni) |> 
    pivot_longer(cols = starts_with("d_"), names_to = "vars", values_to = "vals") |> 
    filter(!is.na(vals)) |> 
    mutate(vars = case_when(
        vars == "d_EF" ~ "Ecological Footprint",
        vars == "d_gni" ~ "GNI [log]",
        vars == "d_gini" ~ "Gini"
    )) |> 
    ggplot(aes(year, vals, group = country)) +
    geom_path(size = 0.2, alpha = 0.5) +
    facet_wrap(~vars, scales = "free") +
    labs(x = "Year", y = "First difference") +
    theme_light(base_size = 7)

# ggsave(
#     plot = p, path = "figures/", file = "first_diff.png", device = "png",
#     width = 6, height = 3, dpi = 300, bg = "white")
p + theme_light(base_size = 20)
```
```{r fig.width=3, fig.height=3}
df_dat |> 
    ggplot(aes(EFconsPerCap, gini)) +
    geom_hline(yintercept = c(30,40), linetype = 2, color = "gray50") +
    geom_vline(xintercept = 1.68, linetype = 2, color = "gray50") +
    geom_density2d() +
    geom_point(aes(color = gni_log)) +
    geom_path(aes(group = country), size = 0.15) +
    scico::scale_color_scico("GNI [log]") +
    labs(y = "Gini", x = "Ecological footprint") +
    theme_light(base_size = 18) +
    theme(legend.position = "top", panel.grid = element_blank())
```
```{r}
df_dat |> 
    ggplot(aes(gni_log, gini)) +
    geom_density2d() +
    geom_point(aes(color = EFconsPerCap)) +
    geom_path(aes(group = country), size = 0.15) +
    scico::scale_color_scico(palette = "berlin") +
    theme_light(base_size = 18)
```
```{r}
df_dat |> 
    ggplot(aes(gni_log, EFconsPerCap)) +
    geom_density2d() +
    geom_point(aes(color = gini)) +
    geom_path(aes(group = country), size = 0.15) +
    scico::scale_color_scico() +
    theme_light(base_size = 18)
```
Who is the weird trajectory out there, world? No it's Luxemburg

```{r}
df_dat |> 
    arrange(desc(EFconsPerCap))
```



## Clustering

I'm not sure if the clustering requires one column per variable * year. Since really the unit of observation is country. Need to read upon it.

```{r}
df_summary <- df_dat |> 
    as_tibble() |> 
    ungroup() |> 
    group_by(country) |> 
    summarize(m = sum(magni, na.rm = TRUE), 
              t = sum(theta, na.rm = TRUE),
              g = sum(gamma, na.rm = TRUE),
              sd_mag = sd(magni, na.rm = TRUE),
              sd_t = sd(theta, na.rm = TRUE),
              sd_g = sd(gamma, na.rm = TRUE), 
              ef = mean(EFconsPerCap, na.rm = TRUE),
              inq = mean(gini, na.rm = TRUE),
              gni = mean(gni_log, na.rm = TRUE),
              #sd_ef = sd(ef, na.rm = TRUE),
              sd_inq = sd(gini, na.rm = TRUE),
              sd_gni = sd(gni_log, na.rm = TRUE)) 

m <- "ward.D2" # minimize the total within-cluster variance

clust_num <- NbClust::NbClust( 
    data = df_summary %>% as.data.frame() %>% 
        select(where(is.numeric)),
    #distance = "maximum",
    min.nc = 2, max.nc = 7, 
    method = m, 
    index = 'all')
```

It is a bit contested because the numeric indices favours 2 clusters with 6 of them, but 3 and 4 clusters are favoured by 5 metrics each. The Hubert index (which is graphical) favours 4 indexes as well, tieing up with the 2 cluster option.

```{r}
## Stability & Internal validation
stab <- clValid::clValid(
    obj = df_summary %>% as.data.frame() %>% 
        select(where(is.numeric)) %>%
        as.matrix(),
    nClust = c(2:7),
    clMethods = c("hierarchical", "kmeans",  #"som", "model", "diana", "fanny",
                 "sota", "pam", "clara", "agnes"),
    validation = c('stability', "internal"),
    #metric = "manhattan",
    method = "ward",
    verbose = FALSE
) ## Hierarchical is the optimal method

clValid::optimalScores(stab)
```
The stability analysis also supports the choice of either 2 or 9 clusters. Partition around medioids does perform well with 9 clusters, but others are supporting the 2 clusters.


```{r}
stab@clusterObjs$pam$`2`$clustering
```

```{r fig.width=7, fig.height=8}
df_summary |> 
    mutate(clus = stab@clusterObjs$pam$`2`$clustering) |> 
    arrange(desc(m)) |> 
    mutate(country = as_factor(country)) |> 
    mutate(country = fct_reorder2(country, m,g)) |> 
    pivot_longer(cols = m:sd_gni, names_to = "vars", values_to = "vals") |> 
    ggplot(aes(vals, country)) +
    geom_col(aes(fill = as.factor(clus))) +
    facet_grid(clus~vars, scales = "free") +
    theme_light(base_size = 10)
```

```{r}
df_dat |> 
    as_tibble() |> 
    group_by(country) |> 
    summarize(
        ef = sum(d_EF, na.rm = TRUE),
        gini = sum(d_gini, na.rm = TRUE),
        gni = sum(d_gni, na.rm = TRUE)
    ) |> 
    mutate(clus = stab@clusterObjs$pam$`2`$clustering) |> 
    ggplot(aes(ef, gini)) +
    geom_segment(
        aes(x = 0, y = 0, xend = ef, yend = gini, color = as.factor(clus)), arrow = arrow(length = unit(0.5, "cm"))) +
    geom_text(aes(label = country)) +
    theme_light(base_size = 20)
```

```{r}
df_dat |> 
    as_tibble() |> 
    group_by(country) |> 
    summarize(
        ef = sum(d_EF, na.rm = TRUE),
        gini = sum(d_gini, na.rm = TRUE),
        gni = sum(d_gni, na.rm = TRUE)
    ) |> 
    mutate(clus = stab@clusterObjs$pam$`2`$clustering) |> 
    ggplot(aes(gni, gini)) +
    geom_segment(aes(x = 0, y = 0, xend = gni, yend = gini, color = as.factor(clus)), arrow = arrow(length = unit(0.5, "cm"))) +
    geom_text(aes(label = country)) +
    theme_light(base_size = 20)
```

### Old stuff

Here is an attempt with another package `kml` that take into consideration the fact that our data is longitudinal. However, looking into the documentation, it seems that it only handles a variable at the time. For the sake of testing:

```{r}
# library(kml)

test_dat <- df_dat %>% 
  select(country, gini, year) %>% 
  as_tibble() %>% 
  pivot_wider(names_from = year, values_from = gini, names_prefix = "yr_") %>% 
  as_data_frame() %>% 
  kml::cld(idAll = "country", timeInData = 2:29)

```
An error I don't understand.
